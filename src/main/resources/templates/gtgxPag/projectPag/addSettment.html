<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"></meta>
    
    <title>addFactory</title>
    
	<link rel="stylesheet" href="../css/common.css">
   <link rel="stylesheet" href="../css/main.css">
<style type="text/css"> 
	.projectTable{
	font-size: 17px;
	}
	.projectTable tr{
	height: 50px;
	}
	</style>
  </head>
  <body>
    <div id="forms" class="mt10">
        <div class="box">
          <div class="box_border">
            <div class="box_top"><b class="pl15">新增结算记录</b></div>
            <div class="box_center">
             <div style="width: 320px;float: left;">
            <table  class="projectTable">
            <tr>
            <td>工程名称：</td>
            <td><p>${data.name}</p></td>
            </tr>
            
            <tr>
            <td>工程类型：</td>
            <td><p>${data.type_name}</p></td>
            </tr>
            
            
            <tr>
            <td>施工位置：</td>
            <td><p>${data.location}</p></td>
            </tr>
            
            <tr>
            <td>施工单位：</td>
            <td><p>${data.construction_org}</p></td>
            </tr>
            
            <tr>
            <td>监理单位：</td>
            <td><p>${data.supervising_org}</p></td>
            </tr>
            
            <tr>
            <td>监理负责人：</td>
            <td><p>${data.supervisor}</p></td>
            </tr>
            
            <tr>
            <td>监理联系方式：</td>
            <td><p>${data.supervisor_phone}</p></td>
            </tr>
            
            <tr>
            <td>安全员/施工员：</td>
            <td><p>${data.constructor}</p></td>
            </tr>
            
            <tr>
            <td>项目经理：</td>
            <td><p>${data.PM}</p></td>
            </tr>
            
             <tr>
            <td>项目经理联系方式：</td>
            <td><p>${data.PM_phone}</p></td>
            </tr>
            
            
            </table>
            </div>
             
             <div style="float: left;width: 1000px;">
             <form  class="jqtransform" method="post" name="userform" id="userform" enctype="multipart/form-data">
               <table class="form_table pt15 pb15" style="width:100%" border="1" cellspacing="0" bordercolor="#F8F2F3">
                 
                  <tr>
                  <td class="td_right">名称：</td>
                  <td><select name="type_id" class="select" id="type_id"> 
                  				<option value=''>&nbsp;&nbsp;&nbsp;&nbsp;请选择&nbsp;&nbsp;&nbsp;&nbsp;</option> 
                  				<#list data.type_list as type_list>
                  				<option value="${(type_list.id)!'' }">&nbsp;&nbsp;&nbsp;&nbsp;${type_list.type_name }&nbsp;&nbsp;&nbsp;&nbsp;</option> 
                  				</#list>
                        		</select>
                        		</td>
                </tr>
                  	<tr>
                  <td class="td_right">网报凭证号:</td>
                  <td><input type="text" name="net_number"  class="input-text lh30" size="40" placeholder="选填">
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">付款阶段:</td>
                  <td><input type="text" name="pay_state"  class="input-text lh30" size="40" placeholder="示例：第一阶段30%">
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">含税金额:</td>
                  <td><input type="text" name="tax_amount" id="tax_amount" onkeyup="count(this);"  class="input-text lh30" size="40" placeholder="九位数以内，小数点两位">
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">税率:</td>
                  <td><input type="text" name="tax_rate" id="tax_rate" onkeyup="count(this);" class="input-text lh30" size="1" >%
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">未税金额:</td>
                  <td><input type="text" name="no_tax_amount" id="no_tax_amount"  class="input-text lh30" size="40" placeholder="输入框自动计算，可修改">
                  </td>
                </tr>
                
                <tr>
                  <td class="td_right">收款凭证:</td>
                  <td>
                  <span class="receiptFileSpan">
                  
                   </span>
                   <input type="file"  id="receiptFile"  onchange="addFile(this,'receiptFile')"  class="input-text lh30" >
                  </td>
                </tr>
                
                <tr>
                  <td class="td_right">退还凭证:</td>
                  <td>
                  <span class="refundFileSpan">
                  
                   </span>
                   <input type="file" id="refundFile" onchange="addFile(this,'refundFile')"  class="input-text lh30" >
                  </td>
                </tr>
                
                 <tr>
                  <td class="td_right">付款凭证:</td>
                  <td>
                  <span class="paymentFileSpan">
                  
                   </span>
                   <input type="file"  id="paymentFile"  onchange="addFile(this,'paymentFile')"  class="input-text lh30" >
                  </td>
                </tr>
                
                <tr>
                  <td class="td_right">出资方:</td>
                  <td><input type="text" name="investor"  class="input-text lh30" size="40">
                  </td>
                </tr>
                
                <tr>
                  <td class="td_right">备注:</td>
                  <td><input type="text" name="remark"  class="input-text lh30" size="40">
                  </td>
                </tr>
                
                 <tr>
                   <td class="td_right">&nbsp;</td>
                   <td class="">
                      <input type="button" id="save" class="btn btn82 btn_save2" value="保存">
                     <input type="button" id="submit" class="btn btn82 btn_save2" value="提交" style="margin-left: 50px;"> 
                   </td>
                 </tr>
               </table>
               </form>
             </div>
              
            </div>
          </div>
        </div>
     </div>
     
     <script type="text/javascript" src="../js/jquery.min.js"></script>
   <script type="text/javascript" src="../js/colResizable-1.3.min.js"></script>
   <script type="text/javascript" src="../js/common.js"></script>
   <script type="text/javascript" src="../js/jquery.form.js"></script> 
	<script type="text/javascript">  
	$(document).ready(function () {
	        //文件删除按钮
	        $(document).on('click','.remove-file-btn',function () {
	        	if(confirm("确认删除么？")){
	        		$(this).closest('.fileDiv').remove();
	        	}
	        })
	        //保存按钮
	        $(document).on('click','#save',function () {
	            submitForm(1);
	        })
	        
	        //提交按钮
	        $(document).on('click','#submit',function () {
	            submitForm(2);
	        })
	    })
    	
    	function count(obj) {
            var a = document.getElementById("tax_amount");
            var b = document.getElementById("tax_rate");
            var s = document.getElementById("no_tax_amount");
            if(a.value == "" || b.value == "") {
            	s.value=0.00;
                return;
            } 
			var aa=a.value.replace(/,/g,'');
            var  n= 1+(parseInt(b.value))/100;
            var num = parseInt(aa)/n;
            s.value=parseInt(num*100)/100;
        }
	
	
    	function submitForm(state){
            var data = {};
            data["type_id"]= $('#type_id option:selected').val();
            data["net_number"]=$("input[name='net_number']").val();
            data["pay_state"]=$("input[name='pay_state']").val();
            data["tax_amount"]=$("input[name='tax_amount']").val().replace(/,/g,'');
            data["tax_rate"]=$("input[name='tax_rate']").val();
            data["no_tax_amount"]=$("input[name='no_tax_amount']").val().replace(/,/g,'');
            data["investor"]=$("input[name='investor']").val();
            data["remark"]=$("input[name='remark']").val();
            data["create_by"]=${activeAdmin.id};
            data.state=state;
            data.project_id=${data.project_id};
            
            
            data.receipt = fileToList('receiptFileSpan');
            data.refund = fileToList('refundFileSpan');
            data.payment = fileToList('paymentFileSpan');
            
            //提交数据
            $.ajax({
		        url:'/manage/web_add_update_settment',
		        secureuri:false,
		        traditional:true,
		        contentType:"application/json",
		        type: 'POST',
	            data: JSON.stringify(data),
		        dataType: 'json',//返回数据的类型
		        success: function (data) {//添加成功
		            if(data>0){
		            	alert("添加成功");
		            	window.location.href="/manage/web_update_settlement_list?project_id="+${data.project_id};
		            }
		        }
		    });
        }
    	
    	
		function fileToList(Cname){   //遍历div  把file改为list
			var List=[];
			var order = 1;
			$('.'+Cname+" .fileDiv").each(function (i,item) {
	            var fileObj={};
	            fileObj.name= $(item).data('name');
	            fileObj.url = $(item).find('a').attr('href');
	            fileObj.type = $(item).find('a').attr('type');
	            fileObj.order = order++;
	            List.push(fileObj);
	        });
	        return List;
		}
    	
		
    	function addFile(obj,Cname){  //上传文件到七牛  
    			var timestamp = (new Date()).getTime(); //时间戳
    			var formData = new FormData();
    	        var file_obj = obj.files[0];
    	        if(file_obj==null){  //没有选择文件 跳出方法
    	        	return false
    	        }
    	        var fileName=file_obj.name;
    	        var strtype = fileName.substring(fileName.lastIndexOf(".")).toLowerCase();//（把路径中的所有字母全部转换为小写）
    	        strtype=fileType(strtype);
                if(strtype==null||strtype==""){
                alert("不支持的文件类型!请重新选择!");
                return false;
                  }
    	        formData.append("token","${token}");  //token
    	        formData.append("key","${prefix}"+timestamp+fileName);  //name
    	        formData.append('file',file_obj);   //文件
    		    $.ajax({
    		        url:'http://up-z1.qiniu.com/',
    		        secureuri:false,
    		        type: 'POST',
    	            data: formData,
    		        dataType: 'json',//返回数据的类型
    		        processData:false,  //
                    contentType: false, 
    		        success: function (data) {//上传成功
    		        	$('#'+Cname).val('');
    		        	var url="${QiniuUrl}"+data.key;
    		        	var str ='';
    		        	if(file_obj.type.indexOf("image")!=-1){ //包含 是图片
    		        		   str +='<div class="fileDiv" data-name="'+file_obj.name+'">'+
    		        		   '<a href="'+url+'" type="image" target=_blank><img style="width: 70px;height: 70px;" src="'+url+'" /></a>'+
    		        		   '<a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a></div>'
    		        	}else{
    		        		str +='<div class="fileDiv" data-name="'+file_obj.name+'">'+
    		        		'<a href="'+url+'" type="'+strtype+'" target=_blank>'+file_obj.name+'</a>'+
    		        		'<a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a></div>'
    		        		
    		        	}
    		        	$('.'+Cname+"Span").append(str);
    		        }
    		    });
    	}
    	
    	
    	function fileType(type){
    		var typeList=[
    			{suffix:".png,.jpg,.gif,.bmp,.jpeg",type:"image"},
    			{suffix:".doc,.docx,.word,.dotx,.dotm,.docm",type:"word"},
    			{suffix:".pdf",type:"pdf"},
    			{suffix:".ppt,.pptx,.ppsx,.pptm,.ppsx,.potx",type:"ppt"},
    			{suffix:".txt",type:"txt"},
    			{suffix:".cad",type:"cad"},
    			{suffix:".xlsx,.xls,.xlsm,.xlsb,.xlsm,.xlam",type:"excel"}
    			];
            var result_type=null;
            for(var i=0;i<typeList.length;i++){
                if(typeList[i].suffix.indexOf(type)!=-1){
                    result_type=typeList[i].type;
                }
            }
            return result_type;
    	}
	</script> 
  </body>
</html>
