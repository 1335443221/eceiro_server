<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"></meta>
    
    <title>addFactory</title>
    
	<link rel="stylesheet" href="../css/common.css">
   <link rel="stylesheet" href="../css/main.css">
  </head>
  <body>
  <div class="lbOverlay"></div>
  <div class="hidden_pro_au">
      <p style="text-align: center">上传图片中……</p>
      <progress max="80" id="progress">您的浏览器不支持progress元素</progress>
  </div>

    <div id="forms" class="mt10">
        <div class="box">
          <div class="box_border">
            <div class="box_top"><b class="pl15">工程基础信息</b></div>
            <div class="box_center">
               <table class="form_table pt15 pb15" style="width:100%" border="1" cellspacing="0" bordercolor="#F8F2F3">
                  <tr>
                  <td class="td_right">名称：</td>
                  <td class=""> 
                  <input type="text" name="name" value="${project.name}" class="input-text lh30" size="40" readonly="readonly">&nbsp;&nbsp;*
                  </td>
                  </tr>
                  <tr>
                  <td class="td_right">工程类型：</td>
                  <td>
                   <input type="text" name="name" value="${project.type_name}" class="input-text lh30" size="40" readonly="readonly">&nbsp;&nbsp;*
                   </td>
                </tr>
                  	<tr>
                  <td class="td_right">工程位置:</td>
                  <td><input type="text" name="location" value="${project.location}" class="input-text lh30" size="40" readonly="readonly">&nbsp;&nbsp;*
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">施工单位:</td>
                  <td><input type="text" name="construction_org" value="${project.construction_org}" class="input-text lh30" size="40" readonly="readonly">&nbsp;&nbsp;*
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">监理单位:</td>
                  <td><input type="text" name="supervising_org" value="${project.supervising_org}"  class="input-text lh30" size="40" readonly="readonly">&nbsp;&nbsp;*
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">监理负责人:</td>
                  <td><input type="text" name="supervisor" value="${project.supervisor}" class="input-text lh30" size="40" readonly="readonly">&nbsp;&nbsp;*
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">监理负责人电话:</td>
                  <td><input type="text" name="supervisor_phone" value="${project.supervisor_phone}"  class="input-text lh30" size="40" readonly="readonly">&nbsp;&nbsp;*
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">安全员/施工员：</td>
                  <td><input type="text" name="constructor"  value="${project.constructor}" class="input-text lh30" size="40" readonly="readonly">&nbsp;&nbsp;*
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">项目经理:</td>
                  <td><input type="text" name="PM" value="${project.PM}"  class="input-text lh30" size="40" readonly="readonly">&nbsp;&nbsp;*
                  </td>
                </tr>
                
                  	<tr>                                             
                  <td class="td_right">项目经理电话:</td>
                  <td><input type="text" name="PM_phone"  value="${project.PM_phone}" class="input-text lh30" size="40" readonly="readonly">&nbsp;&nbsp;*
                  </td>
                </tr>
                
                <tr>
                  <td class="td_right">是否紧急施工：</td>
                  <td>
                  <#if '1' == project.is_urgency>
                  <p>是</p>
                  <#else>
                   <p>否</p>
                  </#if>
                        		</td>
                </tr>
                
                <tr>
                  <td class="td_right">签报文件:</td>
                  <td>
                  <span class="sign_fileFileSpan">
                  <#list project.sign_file as fileList>
                    <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                      <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
                </div>
                  </#list>
                  </span>
                   <input type="file"  id="sign_fileFile"  onchange="addFile(this,'sign_fileFile')"  class="input-text lh30" >
                  </td>
                </tr>
                
                 <tr>
                  <td class="td_right">甲方或监理同意书:</td>
                   <td>
					<span class="owner_consentFileSpan">
					<#list project.owner_consent as fileList>
                 <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                        <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
                </div>
                  </#list>
                  </span>
                   <input type="file" id="owner_consentFile" onchange="addFile(this,'owner_consentFile')"  class="input-text lh30" >
                  </td>
              	  
                </tr>
                
               </table>
            </div>
          </div>
          
          
         <div class="box_border">
            <div class="box_top"><b class="pl15">工程前期准备阶段-汇总资料</b></div>
            <div class="box_center">
               <table class="form_table pt15 pb15" style="width:100%" border="1" cellspacing="0" bordercolor="#F8F2F3">
                  <tr>
                  <td class="td_right">合同：</td>
                  <td>
                  <span class="contractFileSpan">
                  <#list project.early_data.contract as fileList>
       <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                      <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       </div>
                  </#list>
                  </span>
                   <input type="file"  id="contractFile"  onchange="addFile(this,'contractFile')"  class="input-text lh30" >&nbsp;&nbsp;*
                  </td>
                  </tr>
                  
                  
                  <tr>
                  <td class="td_right">企业资质：</td>
                  <td>
        		<span class="qualificationFileSpan">
                  <#list project.early_data.qualification as fileList>
          <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                    <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       		</div>
                  </#list>
                  </span>
                 <input type="file"  id="qualificationFile"  onchange="addFile(this,'qualificationFile')"  class="input-text lh30" >&nbsp;&nbsp;*
                  </td>
                </tr>
                  	<tr>
                  <td class="td_right">安全协议:</td>
                  <td>
                 <span class="sec_protocolFileSpan">
                  <#list project.early_data.sec_protocol as fileList>
          <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                     <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       		</div>
                  </#list>
                  </span>
                  <input type="file"  id="sec_protocolFile"  onchange="addFile(this,'sec_protocolFile')"  class="input-text lh30" >&nbsp;&nbsp;*
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">开工证:</td>
                  <td>
                  <span class="start_credentialFileSpan">
                  <#list project.early_data.start_credential as fileList>
          <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                      <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       		</div>
                  </#list>
                  </span>
                  <input type="file"  id="start_credentialFile"  onchange="addFile(this,'start_credentialFile')"  class="input-text lh30" >
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">出入证:</td>
                 <td>
                 <span class="io_credentialFileSpan">
                  <#list project.early_data.io_credential as fileList>
          <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                     <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       		</div>
                  </#list>
                  </span>
                  <input type="file"  id="io_credentialFile"  onchange="addFile(this,'io_credentialFile')"  class="input-text lh30" >
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">施工配合费:</td>
                 <td>
                  <span class="constructionfeeFileSpan">
                  <#list project.early_data.constructionfee as fileList>
          <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                      <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       		</div>
                  </#list>
                  </span>
                  <input type="file"  id="constructionfeeFile"  onchange="addFile(this,'constructionfeeFile')"  class="input-text lh30" >
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">入场前三级安全培训:</td>
                  <td>
                  <span class="safety_trainingFileSpan">
                  <#list project.early_data.safety_training as fileList>
          <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                      <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       		</div>
                  </#list>
                  </span>
                  <input type="file"  id="safety_trainingFile"  onchange="addFile(this,'safety_trainingFile')"  class="input-text lh30" >
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">人员信息：</td>
                  <td>
                  <span class="people_informationFileSpan">
                  <#list project.early_data.people_information as fileList>
          <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                      <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       		</div>
                  </#list>
                  </span>
                  <input type="file"  id="people_informationFile"  onchange="addFile(this,'people_informationFile')"  class="input-text lh30" >
                  </td>
                </tr>
                
                  	<tr>
                  <td class="td_right">施工安全保证金收据:</td>
                  <td>
                 <span class="csd_receiptFileSpan">
                  <#list project.early_data.csd_receipt as fileList>
          <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                     <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       		</div>
                  </#list>
                  </span>
                  <input type="file"  id="csd_receiptFile"  onchange="addFile(this,'csd_receiptFile')"  class="input-text lh30" >
                  </td>
                </tr>
                
                  	<tr>                                             
                  <td class="td_right">特种作业人员持证情况:</td>
                 <td>
                  <span class="sop_certificateFileSpan">
                  <#list project.early_data.sop_certificate as fileList>
          <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                      <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       		</div>
                  </#list>
                  </span>
                  <input type="file"  id="sop_certificateFile"  onchange="addFile(this,'sop_certificateFile')"  class="input-text lh30" >
                  </td>
                </tr>
                 <tr>
                  <td class="td_right">是否报安检/消防备案（300平米以上）：</td>
                   <td>
                       <#if '1' == project.early_data.is_securitycheck>
                       <p>是</p>
                        <#else>
                        <p>否</p>
                    </#if>
                     </td>
                </tr>
                
                <tr>
                  <td class="td_right">备案情况:</td>
                  
                   <td>
                 <span class="recordFileSpan">
                  <#list project.early_data.record as fileList>
          <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                     <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       		</div>
                  </#list>
                  </span>
                  <input type="file"  id="recordFile"  onchange="addFile(this,'recordFile')"  class="input-text lh30" >
                  </td>
                </tr>
                
                 <tr>
                  <td class="td_right">施工图纸:</td>
                  <td>
                  <span class="drawingsFileSpan">
                  <#list project.early_data.drawings as fileList>
          <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                      <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       		</div>
                  </#list>
                  </span>
                  <input type="file"  id="drawingsFile"  onchange="addFile(this,'drawingsFile')"  class="input-text lh30" >
                  </td>
                </tr>
                
                
                <tr>
                  <td class="td_right">其他（备案等资料）:</td>
                  
                   <td>
                  <span class="elseFileSpan">
                  <#list project.early_data.else as fileList>
          <div class="fileDiv" data-name="${fileList.name}">
                  <#if fileList.type?index_of("image")!=-1>
		    	 <a href="${fileList.url}" type="${fileList.type}" target=_blank><img style="width: 70px;height: 70px;" src="${fileList.url}" /></a>
				  <#else>
		        <a href="${fileList.url}" type="${fileList.type}" target=_blank>${fileList.name}</a>
                  </#if>
                      <#if activeAdmin.rid=='3'>
                      <a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a>
      		            </#if>
       		</div>
                  </#list>
                  </span>
                  <input type="file"  id="elseFile"  onchange="addFile(this,'elseFile')"  class="input-text lh30" >
                  </td>
                </tr>
              
                <tr>                                             
                  <td class="td_right">创建时间:</td>
                  <td>
                  <p>${project.early_data.create_at}</p>
                  </td>
                </tr>
                
                 <tr>
                   <td class="td_right">&nbsp;</td>
                   <td class="">
                     <input type="button" id="submit" class="btn btn82 btn_save2" value="补录" style="margin-left: 50px;">
                   </td>
                 </tr>
               </table>
               </form>
            </div>
          </div>
          
        </div>
     </div>
     
  <script type="text/javascript" src="../js/jquery.min.js"></script>
   <script type="text/javascript" src="../js/colResizable-1.3.min.js"></script>
   <script type="text/javascript" src="../js/common.js"></script>
   <script type="text/javascript" src="../js/jquery.form.js"></script> 
	<script type="text/javascript">  
	$(document).ready(function () {
	        //文件删除按钮
	        $(document).on('click','.remove-file-btn',function () {
	        	if(confirm("确认删除么？")){
	        		$(this).closest('.fileDiv').remove();
	        	}
	        })
	        //保存按钮
	        $(document).on('click','#save',function () {
	            submitForm(2);
	        })
	        
	        //提交按钮
	        $(document).on('click','#submit',function () {
	        	if(confirm("确认补录么？补录后将无法修改")){
                    submitForm(4);
	        	}
	        })
	    })
    	
    	
    	function submitForm(state){
			var appdata = {};
			var data = {};  //工程信息
            data["name"]=$("input[name='name']").val();
            data["project_type"]= ${project.project_type};
            data["location"]=$("input[name='location']").val();
            data["construction_org"]=$("input[name='construction_org']").val();
            data["supervising_org"]=$("input[name='supervising_org']").val();
            data["supervisor"]=$("input[name='supervisor']").val();
            data["supervisor_phone"]=$("input[name='supervisor_phone']").val();
            data["constructor"]=$("input[name='constructor']").val();
            data["PM"]=$("input[name='PM']").val();
            data["PM_phone"]=$("input[name='PM_phone']").val();
            data["is_urgency"]= $('#is_urgency option:selected').val();
            data["create_by"]=${activeAdmin.id};
            data.sign_file = fileToList('sign_fileFileSpan');
            data.owner_consent =fileToList('owner_consentFileSpan');
            data.save_state=state;
            data.id=${project.id};
            
            var early_data={};  //早期信息
           <#if project.early_data.is_securitycheck==""||project.early_data.is_securitycheck==null>
                early_data.is_securitycheck=0;
                <#else>
                 early_data.is_securitycheck=${project.early_data.is_securitycheck};
            </#if>
            early_data.create_by=${activeAdmin.id};
            early_data.project_id=${project.id};
            early_data.state=state;
            early_data.contract = fileToList('contractFileSpan');
            early_data.qualification = fileToList('qualificationFileSpan');
            early_data.sec_protocol = fileToList('sec_protocolFileSpan');
            early_data.start_credential = fileToList('start_credentialFileSpan');
            early_data.io_credential = fileToList('io_credentialFileSpan');
            early_data.constructionfee = fileToList('constructionfeeFileSpan');
            early_data.safety_training = fileToList('safety_trainingFileSpan');
            early_data.people_information = fileToList('people_informationFileSpan');
            early_data.csd_receipt = fileToList('csd_receiptFileSpan');
            early_data.sop_certificate = fileToList('sop_certificateFileSpan');
            early_data.record = fileToList('recordFileSpan');
            early_data.drawings = fileToList('drawingsFileSpan');
            early_data.else = fileToList('elseFileSpan');
            appdata.early_data=early_data;
            appdata.project_data=data;
            appdata.state=state;
            appdata.project_id=${project.id};
            show();
          //提交数据
            $.ajax({
		        url:'/manage/update_project',
		        secureuri:false,
		        traditional:true,
		        contentType:"application/json",
		        type: 'POST',
	            data: JSON.stringify(appdata),
		        dataType: 'json',//返回数据的类型
		        success: function (data) {//添加成功
		            if(data>0){
                        goprogress();
		            }
		        }
		    });
        }
    function show(){
        $(".lbOverlay").css({"height":window.screen.availHeight});
        $(".lbOverlay").show();
        var st=$(document).scrollTop(); //页面滑动高度
        var objH=$(".hidden_pro_au").height();//浮动对象的高度
        var ch=$(window).height();//屏幕的高度
        var objT=Number(st)+(Number(ch)-Number(objH))/2;   //思路  浮动高度+（（屏幕高度-对象高度））/2
        $(".hidden_pro_au").css("top",objT);
        var sl=$(document).scrollLeft(); //页面滑动左移宽度
        var objW=$(".hidden_pro_au").width();//浮动对象的宽度
        var cw=$(window).width();//屏幕的宽度
        var objL=Number(sl)+(Number(cw)-Number(objW))/2; //思路  左移浮动宽度+（（屏幕宽度-对象宽度））/2
        $(".hidden_pro_au").css("left",objL);
        $(".hidden_pro_au").slideDown("20000");//这里显示方式多种效果
    }
    function goprogress(){
        var pro=document.getElementById("progress");
        gotoend(pro,0);
    }
    function gotoend(pro,value){
        var value=value+1;
        pro.value=value;
        if(value<100) {
            setTimeout(function(){gotoend(pro,value);},10)
        }else{
            setTimeout(function(){alert("补录成功!")},10);
            window.location.href="/manage/web_project_list?pageindex=1";
        }
    }
	function fileToList(Cname){   //遍历div  把file改为list
		var List=[];
		var order = 1;
		$('.'+Cname+" .fileDiv").each(function (i,item) {
            var fileObj={};
            fileObj.name= $(item).data('name');
            fileObj.url = $(item).find('a').attr('href');
            fileObj.type = $(item).find('a').attr('type');
            fileObj.order = order++;
            List.push(fileObj);
        });
        return List;
	}
	
	
	function addFile(obj,Cname){  //上传文件到七牛  
			var timestamp = (new Date()).getTime(); //时间戳
			var formData = new FormData();
	        var file_obj = obj.files[0];
	        if(file_obj==null){  //没有选择文件 跳出方法
	        	return false
	        }
	        formData.append("token","${token}");  //token
	        formData.append("key",timestamp+file_obj.name);  //name
	        formData.append('file',file_obj);   //文件
	        var fileName=file_obj.name;
	        var strtype = fileName.substring(fileName.lastIndexOf(".")).toLowerCase();//（把路径中的所有字母全部转换为小写）
	        strtype=fileType(strtype);
                if(strtype==null||strtype==""){
                alert("不支持的文件类型!请重新选择!");
                return false;
                  }
		    $.ajax({
		        url:'http://up-z1.qiniu.com/',
		        secureuri:false,
		        type: 'POST',
	            data: formData,
		        dataType: 'json',//返回数据的类型
		        processData:false,  //
                contentType: false, 
		        success: function (data) {//上传成功
		        	$('#'+Cname).val('');
		        	var url="${QiniuUrl}"+data.key;
		        	var str ='';
		        	if(file_obj.type.indexOf("image")!=-1){ //包含 是图片
		        		   str +='<div class="fileDiv" data-name="'+file_obj.name+'">'+
		        		   '<a href="'+url+'" type="image" target=_blank><img style="width: 70px;height: 70px;" src="'+url+'" /></a>'+
		        		   '<a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a></div>'
		        	}else{
		        		str +='<div class="fileDiv" data-name="'+file_obj.name+'">'+
		        		'<a href="'+url+'" type="'+strtype+'" target=_blank>'+file_obj.name+'</a>'+
		        		'<a href="javascript:;" class="remove-file-btn"><img src="/images/gtgx/deleteFile.png" class="deleteFile"/></a></div>'
		        	}
		        	$('.'+Cname+"Span").append(str);
		        }
		    });
	}
	
	
	function fileType(type){
		var typeList=[
			{suffix:".png,.jpg,.gif,.bmp,.jpeg",type:"image"},
			{suffix:".doc,.docx,.word,.dotx,.dotm,.docm",type:"word"},
			{suffix:".pdf",type:"pdf"},
			{suffix:".ppt,.pptx,.ppsx,.pptm,.ppsx,.potx",type:"ppt"},
			{suffix:".txt",type:"txt"},
			{suffix:".cad",type:"cad"},
			{suffix:".xlsx,.xls,.xlsm,.xlsb,.xlsm,.xlam",type:"excel"}
			];
        var result_type=null;
        for(var i=0;i<typeList.length;i++){
            if(typeList[i].suffix.indexOf(type)!=-1){
                result_type=typeList[i].type;
            }
        }
        return result_type;
	}
</script> 
</body>
</html>
